<!DOCTYPE html>
<html lang="ja">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ログイン - 持出承認システム</title>
    <link href="{% static 'vendor/bootstrap/5.3.3/css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'vendor/fontawesome/6.5.2/css/all.min.css' %}" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            width: 100%;
            max-width: 400px;
        }
        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .login-header i {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 1rem;
        }
        .login-header h2 {
            color: #333;
            font-weight: 300;
        }
        .form-floating label {
            color: #666;
        }
        .btn-login {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 500;
            transition: transform 0.2s;
        }
        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .alert {
            border-radius: 10px;
            border: none;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-header">
            <i class="fas fa-shield-alt"></i>
            <h2>持出承認システム</h2>
            <p class="text-muted">ユーザ名とパスワードを入力してください</p>
        </div>

        {# メッセージ: 上部に端的な結果、下部に対処。初期状態では何も表示しない #}
        {% if messages %}
            <div id="login-results" class="mb-2">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} py-2 mb-2 summary-item" data-full="{{ message|escape }}" role="alert"></div>
                {% endfor %}
            </div>
        {% endif %}

        <form method="post">
            {% csrf_token %}
            <div class="form-floating mb-3">
                <input type="text" class="form-control" id="username" name="username" placeholder="ユーザー名" required>
                <label for="username"><i class="fas fa-user me-2"></i>ユーザー名</label>
            </div>
            
            <div class="form-floating mb-4">
                <input type="password" class="form-control" id="password" name="password" placeholder="パスワード" required>
                <label for="password"><i class="fas fa-lock me-2"></i>パスワード</label>
            </div>

            <div id="login-actions" class="mb-3 d-none">
                <div class="card border-0 shadow-sm">
                    <div class="card-body py-2 px-3">
                        <h6 class="text-muted small mb-2"><i class="fa fa-wrench me-1"></i>対処方法</h6>
                        <ul class="small mb-0 ps-3" id="action-list" style="list-style: disc;"></ul>
                    </div>
                </div>
            </div>

            <div class="d-grid mt-3">
                <button type="submit" class="btn btn-primary btn-login">
                    <i class="fas fa-sign-in-alt me-2"></i>ログイン
                </button>
            </div>
        </form>

    {# 初期表示では管理者への問い合わせメッセージは出さない #}
    </div>

    <script src="{% static 'vendor/bootstrap/5.3.3/js/bootstrap.bundle.min.js' %}"></script>
    <script>
    // メッセージを「要約(最初の一文)」と「詳細(対処)」に分離して表示
    document.addEventListener('DOMContentLoaded', function() {
        const summaryItems = Array.from(document.querySelectorAll('.summary-item'));
        if (!summaryItems.length) return;
        const actionList = document.getElementById('action-list');
        const actionBox = document.getElementById('login-actions');

        // 優先度: ネットワーク/LDAP接続障害 > 資格情報エラー
        const NETWORK_PATTERNS = [
            /LDAPサーバー.*到達できません/, /LDAPサーバー.*接続不可/, /ネットワーク.*接続エラー/, /タイムアウト/
        ];
        const CREDENTIAL_PATTERNS = [
            /ユーザー名またはパスワードが正しくありません/
        ];

        const isNetworkMessage = full => NETWORK_PATTERNS.some(re => re.test(full));
        const isCredentialMessage = full => CREDENTIAL_PATTERNS.some(re => re.test(full));

        const networkItems = summaryItems.filter(it => isNetworkMessage((it.getAttribute('data-full')||'')));

        if (networkItems.length) {
            // ネットワーク系がある場合は、それ以外の(特に資格情報)メッセージを削除
            summaryItems.forEach(it => {
                if (!networkItems.includes(it)) {
                    it.remove();
                }
            });
        }

        // 表示対象（フィルタ後）を再取得
        const remaining = Array.from(document.querySelectorAll('.summary-item'));
        remaining.forEach(item => {
            const full = (item.getAttribute('data-full') || '').trim();
            if (!full) return;
            const parts = full.split(/。+/).filter(p => p.length);
            if (!parts.length) return;
            item.textContent = parts[0] + '。';
            if (parts.length > 1) {
                const rest = parts.slice(1).join('。').trim();
                if (rest) {
                    const li = document.createElement('li');
                    li.textContent = rest + '。';
                    actionList.appendChild(li);
                }
            }
            // ネットワークエラーの場合で対処がまだない時は補助ヒントを追加（冪等）
            if (isNetworkMessage(full) && ![...actionList.children].some(li => li.dataset.auto === 'net-extra')) {
                const li = document.createElement('li');
                li.dataset.auto = 'net-extra';
                li.textContent = 'LAN/無線/VPN 状態を確認し、問題なければ運用窓口へ連絡してください。';
                actionList.appendChild(li);
            }
        });

        if (actionList.children.length) {
            actionBox.classList.remove('d-none');
        }
    });
    </script>
</body>
</html>
