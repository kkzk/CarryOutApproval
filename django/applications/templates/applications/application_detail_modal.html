{% load humanize %}
<div class="modal-header">
    <h5 class="modal-title">
        <i class="bi bi-file-earmark-text"></i> 申請詳細 #{{ application.id }}
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>

<div class="modal-body">
    <div class="row">
        <div class="col-md-6">
            <h6><i class="bi bi-info-circle"></i> 基本情報</h6>
            <table class="table table-sm">
                <tr>
                    <th width="100">申請ID:</th>
                    <td>#{{ application.id }}</td>
                </tr>
                <tr>
                    <th>ファイル名:</th>
                    <td>{{ application.original_filename }}</td>
                </tr>
                <tr>
                    <th>ファイルサイズ:</th>
                    <td>{{ application.file_size|filesizeformat }}</td>
                </tr>
                <tr>
                    <th>形式:</th>
                    <td>{{ application.content_type }}</td>
                </tr>
                <tr>
                    <th>ステータス:</th>
                    <td>
                        <span class="badge 
                            {% if application.status == 'pending' %}bg-warning text-dark
                            {% elif application.status == 'approved' %}bg-success
                            {% elif application.status == 'rejected' %}bg-danger
                            {% else %}bg-secondary{% endif %}">
                            {{ application.get_status_display }}
                        </span>
                    </td>
                </tr>
            </table>
        </div>
        <div class="col-md-6">
            <h6><i class="bi bi-people"></i> 関係者情報</h6>
            <table class="table table-sm">
                <tr>
                    <th width="100">申請者:</th>
                    <td>{{ application.applicant }}</td>
                </tr>
                <tr>
                    <th>承認者:</th>
                    <td>{{ application.approver }}</td>
                </tr>
                <tr>
                    <th>申請日時:</th>
                    <td>{{ application.created_at|date:"Y年n月j日 H:i" }}</td>
                </tr>
                {% if application.approved_at %}
                <tr>
                    <th>承認日時:</th>
                    <td>{{ application.approved_at|date:"Y年n月j日 H:i" }}</td>
                </tr>
                {% endif %}
            </table>
        </div>
    </div>

    {% if application.comment %}
    <div class="mt-3">
        <h6><i class="bi bi-chat-left-text"></i> 申請理由</h6>
        <div class="border rounded p-3 bg-light">
            {{ application.comment|linebreaks }}
        </div>
    </div>
    {% endif %}

    {% if application.approval_comment %}
    <div class="mt-3">
        <h6><i class="bi bi-chat-right-text"></i> 承認コメント</h6>
        <div class="border rounded p-3 bg-light">
            {{ application.approval_comment|linebreaks }}
        </div>
    </div>
    {% endif %}

    <!-- ファイルプレビュー（画像の場合） -->
    {% if application.content_type|slice:":5" == "image" %}
    <div class="mt-3">
        <h6><i class="bi bi-image"></i> プレビュー</h6>
        <div class="text-center">
            <img src="{{ application.file.url }}" class="img-fluid" style="max-height: 300px;">
        </div>
    </div>
    {% endif %}

    <!-- 承認・却下フォーム -->
    {% if application.status == 'pending' and application.approver == user %}
    <div class="mt-4">
        <h6><i class="bi bi-check-circle"></i> 承認・却下</h6>
        <form hx-post="{% url 'applications:update-application-status' %}" 
              hx-vals='{"application_id": "{{ application.id }}"}'
              hx-target="#modal-content"
              hx-swap="outerHTML">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">ステータス</label>
                    <select name="status" class="form-select" required>
                        <option value="approved">承認</option>
                        <option value="rejected">却下</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">コメント</label>
                    <textarea name="comment" class="form-control" rows="3" placeholder="承認・却下の理由（任意）"></textarea>
                </div>
            </div>
            <div class="mt-3">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check"></i> 更新
                </button>
            </div>
        </form>
    </div>
    {% endif %}
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
    {% if application.file %}
    <a href="{{ application.file.url }}" target="_blank" class="btn btn-outline-primary">
        <i class="bi bi-download"></i> ダウンロード
    </a>
    {% endif %}
</div>
